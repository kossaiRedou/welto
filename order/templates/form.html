{% extends 'base_with_sidebar.html' %}

{% block title %}Nouvelle vente{% endblock %}

{% block page_title %}
<i class="bi bi-plus-circle me-2"></i>
Nouvelle vente
{% endblock %}

{% block page_subtitle %}
<small class="text-muted">Créer une nouvelle commande avec sélection de client</small>
{% endblock %}

{% block extra_css %}
<style>
    .order-form-card {
        border-radius: 15px;
        border: none;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
    }
    
    .order-form-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(0,0,0,0.12);
    }
    
    .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 25px;
    }
    
    .section-header h5 {
        margin: 0;
        font-weight: 600;
    }
    
    .client-search-card {
        background: linear-gradient(135deg,rgb(74, 53, 77) 0%,rgb(82, 19, 28) 100%);
        color: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
    }
    
    .client-search-card .form-label {
        color: white;
        font-weight: 600;
    }
    
    .client-search-card .input-group-text {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
    }
    
    .client-search-card .form-control {
        border: 1px solid rgba(255,255,255,0.3);
        background: rgba(255,255,255,0.1);
        color: white;
    }
    
    .client-search-card .form-control::placeholder {
        color: rgba(255,255,255,0.7);
    }
    
    .client-search-card .form-control:focus {
        background: rgba(255,255,255,0.15);
        border-color: rgba(255,255,255,0.5);
        color: white;
        box-shadow: 0 0 0 0.2rem rgba(255,255,255,0.25);
    }
    
    .selected-client {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 15px;
    }
    
    .order-details-card {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
    }
    
    .order-details-card .form-label {
        font-weight: 600;
        color: #495057;
    }
    
    .info-alert {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 15px;
    }
    
    .btn-create-order {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 25px;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-create-order:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-today {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        border: none;
        border-radius: 20px;
        padding: 8px 20px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }
    
    .btn-today:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(79, 172, 254, 0.4);
    }
    
    .list-group-item {
        border: none;
        border-radius: 8px;
        margin-bottom: 5px;
        transition: all 0.3s ease;
    }
    
    .list-group-item:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: translateX(5px);
    }
    
    .form-check-input:checked {
        background-color: #667eea;
        border-color: #667eea;
    }
    
    .new-client-form {
        background: rgba(255,255,255,0.1);
        border-radius: 10px;
        padding: 20px;
        margin-top: 15px;
    }
    
    .alert {
        border-radius: 10px;
        border: none;
    }
    
    .breadcrumb {
        background: transparent;
        padding: 0;
    }
    
    .breadcrumb-item a {
        color: #667eea;
        text-decoration: none;
    }
    
    .breadcrumb-item.active {
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
                <div class="row">
        <div class="col-12">
            <div class="card order-form-card">
                <form method="post" class="form-horizontal" id="order-form">
                    {% csrf_token %}
                    <div class="card-body">
                        <!-- Section Client -->
                        <div class="section-header">
                            <h5>
                                <i class="bi bi-person-circle me-2"></i>
                                Sélection du Client
                            </h5>
                        </div>
                        
                        <div class="client-search-card">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">
                                        <i class="bi bi-search me-1"></i>
                                        Rechercher par téléphone
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="bi bi-telephone"></i>
                                        </span>
                                        <input type="text" 
                                               class="form-control" 
                                               id="phone-search" 
                                               placeholder="Tapez le numéro de téléphone..."
                                               autocomplete="off">
                                    </div>
                                    
                                    <!-- Résultats de recherche -->
                                    <div id="client-results" class="mt-3" style="display: none;">
                                        <div class="list-group" id="client-list"></div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label">
                                        <i class="bi bi-check-circle me-1"></i>
                                        Client sélectionné
                                    </label>
                                    <div class="selected-client" id="selected-client" style="display: none;">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong id="client-name"></strong><br>
                                                <small id="client-phone" style="opacity: 0.9;"></small>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-light" id="clear-client">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Message si pas de client -->
                                    <div class="text-center text-white-50" id="no-client">
                                        <i class="bi bi-person-x me-2"></i>
                                        Aucun client sélectionné (optionnel)
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Création rapide de client -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="create-new-client">
                                        <label class="form-check-label text-white" for="create-new-client">
                                            <i class="bi bi-plus-circle me-1"></i>
                                            Créer un nouveau client
                                        </label>
                                    </div>
                                    
                                    <!-- Formulaire création client -->
                                    <div id="new-client-form" class="new-client-form" style="display: none;">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label text-white">Nom complet</label>
                                                <input type="text" class="form-control" id="new-client-name" placeholder="Nom du client">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label text-white">Téléphone</label>
                                                <input type="text" 
                                                       class="form-control" 
                                                       id="new-client-phone" 
                                                       placeholder="Ex: 7123456 (7 chiffres)"
                                                       maxlength="7"
                                                       pattern="[0-9]{7}">
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                <button type="button" class="btn btn-light w-100" id="save-new-client">
                                                    <i class="bi bi-plus me-1"></i>
                                                    Créer
                                                </button>
                                            </div>
                                        </div>
                        </div>
                    </div>
                </div>
            </div>
                        
                        <!-- Section Détails de la commande -->
                        <div class="section-header">
                            <h5>
                                <i class="bi bi-cart-check me-2"></i>
                                Détails de la Commande
                            </h5>
                        </div>
                        
                        <div class="order-details-card">
                <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-calendar-event me-1"></i>
                                            {{ form.date.label }}
                                        </label>
                                        {{ form.date }}
                                        {% if form.date.help_text %}
                                            <small class="form-text text-muted">
                                                <i class="bi bi-info-circle me-1"></i>
                                                {{ form.date.help_text }}
                                            </small>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-alert">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>Numéro de commande :</strong> Sera généré automatiquement après création
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Champ title masqué -->
                            {{ form.title }}
                            
                            <!-- Champ caché pour l'ID client -->
                            <input type="hidden" id="client_id" name="client_id" value="">
                        </div>
                    </div>
                    
                    <div class="card-footer text-center" style="background: transparent; border-top: none;">
                        <button type="submit" class="btn btn-create-order btn-lg">
                            <i class="bi bi-check-circle me-2"></i>
                            Créer la Commande
                        </button>
                </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let searchTimeout;
    let selectedClientId = null;
    
    // === RECHERCHE DE CLIENTS ===
    $('#phone-search').on('input', function() {
        const phone = $(this).val().trim();
        
        clearTimeout(searchTimeout);
        
        if (phone.length < 2) {
            $('#client-results').hide();
            return;
        }
        
        searchTimeout = setTimeout(function() {
            searchClients(phone);
        }, 300); // Délai de 300ms pour éviter trop de requêtes
    });
    
    function searchClients(phone) {
        $.ajax({
            url: '{% url "client:ajax_search" %}',
            type: 'GET',
            data: { phone: phone },
            success: function(response) {
                if (response.success) {
                    displayClientResults(response.clients);
                } else {
                    console.error('Erreur recherche:', response.error);
                }
            },
            error: function(xhr, status, error) {
                console.error('Erreur AJAX:', error);
            }
        });
    }
    
    function displayClientResults(clients) {
        const clientList = $('#client-list');
        clientList.empty();
        
        if (clients.length === 0) {
            clientList.append(`
                <div class="list-group-item text-muted">
                    <i class="bi bi-search me-2"></i>
                    Aucun client trouvé
                </div>
            `);
        } else {
            clients.forEach(function(client) {
                clientList.append(`
                    <a href="#" class="list-group-item list-group-item-action client-item" data-client-id="${client.id}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${client.name}</strong><br>
                                <small class="text-muted">${client.phone}</small>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">
                                    ${client.total_orders} commande(s)<br>
                                    Dernière: ${client.last_order}
                                </small>
                            </div>
                        </div>
                    </a>
                `);
            });
        }
        
        $('#client-results').show();
    }
    
    // === SÉLECTION D'UN CLIENT ===
    $(document).on('click', '.client-item', function(e) {
        e.preventDefault();
        
        const clientId = $(this).data('client-id');
        const clientName = $(this).find('strong').text();
        const clientPhone = $(this).find('small').first().text();
        
        selectClient(clientId, clientName, clientPhone);
    });
    
    function selectClient(id, name, phone) {
        selectedClientId = id;
        
        // Mettre à jour l'interface
        $('#client-name').text(name);
        $('#client-phone').text(phone);
        $('#selected-client').show();
        $('#no-client').hide();
        $('#client_id').val(id);
        
        // Cacher les résultats et vider la recherche
        $('#client-results').hide();
        $('#phone-search').val('');
        
        // Décocher la création de nouveau client
        $('#create-new-client').prop('checked', false);
        $('#new-client-form').hide();
    }
    
    // === EFFACER LA SÉLECTION ===
    $('#clear-client').click(function() {
        clearClientSelection();
    });
    
    function clearClientSelection() {
        selectedClientId = null;
        $('#selected-client').hide();
        $('#no-client').show();
        $('#client_id').val('');
        $('#phone-search').val('');
        $('#client-results').hide();
    }
    
    // === CRÉATION DE NOUVEAU CLIENT ===
    $('#create-new-client').change(function() {
        if ($(this).is(':checked')) {
            $('#new-client-form').show();
            clearClientSelection();
            $('#phone-search').val('').prop('disabled', true);
        } else {
            $('#new-client-form').hide();
            $('#phone-search').prop('disabled', false);
        }
    });
    
    // Validation temps réel du téléphone dans création rapide
    $('#new-client-phone').on('input', function() {
        const phone = $(this).val().replace(/\D/g, ''); // Garder seulement les chiffres
        $(this).val(phone); // Mettre à jour le champ
        
        if (phone.length > 7) {
            $(this).val(phone.substring(0, 7)); // Limiter à 7 chiffres
        }
    });
    
    $('#save-new-client').click(function() {
        const name = $('#new-client-name').val().trim();
        const phone = $('#new-client-phone').val().trim();
        
        if (!name || !phone) {
            showAlert('warning', 'Veuillez remplir le nom et le téléphone');
            return;
        }
        
        if (phone.length !== 7 || !/^\d{7}$/.test(phone)) {
            showAlert('warning', 'Le numéro de téléphone doit contenir exactement 7 chiffres (format Gambie)');
            return;
        }
        
        const btn = $(this);
        const originalText = btn.html();
        btn.prop('disabled', true).html('<i class="bi bi-hourglass-split me-1"></i>Création...');
        
        $.ajax({
            url: '{% url "client:ajax_create" %}',
            type: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({
                name: name,
                phone: phone
            }),
            success: function(response) {
                if (response.success) {
                    // Sélectionner le nouveau client
                    selectClient(response.client.id, response.client.name, response.client.phone);
                    
                    // Réinitialiser le formulaire
                    $('#new-client-name').val('');
                    $('#new-client-phone').val('');
                    $('#create-new-client').prop('checked', false);
                    $('#new-client-form').hide();
                    $('#phone-search').prop('disabled', false);
                    
                    // Message de succès
                    showAlert('success', response.message);
                } else {
                    showAlert('danger', response.error);
                }
            },
            error: function(xhr, status, error) {
                showAlert('danger', 'Erreur de connexion. Veuillez réessayer.');
                console.error('Erreur AJAX:', error);
            },
            complete: function() {
                btn.prop('disabled', false).html(originalText);
            }
        });
    });
    
    // === FONCTION D'ALERTE ===
    function showAlert(type, message) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-triangle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        $('body').append(alertHtml);
        
        setTimeout(function() {
            $('.alert').fadeOut();
        }, 5000);
    }
    
    // === CACHER LES RÉSULTATS QUAND ON CLIQUE AILLEURS ===
    $(document).click(function(e) {
        if (!$(e.target).closest('#phone-search, #client-results').length) {
            $('#client-results').hide();
        }
    });
    
    // === GESTION DE LA DATE PAR DÉFAUT ===
    $(document).ready(function() {
        const dateField = $('#id_date');
        
        // Bouton pour définir la date d'aujourd'hui
        if (dateField.length) {
            const todayButton = $(`
                <button type="button" class="btn btn-today mt-2" id="set-today">
                    <i class="bi bi-calendar-today me-1"></i>
                    Aujourd'hui
                </button>
            `);
            
            dateField.after(todayButton);
            
            $('#set-today').click(function() {
                const today = new Date().toISOString().split('T')[0];
                dateField.val(today);
                $(this).removeClass('btn-today').addClass('btn-success');
                setTimeout(() => {
                    $(this).removeClass('btn-success').addClass('btn-today');
                }, 1000);
            });
            
            // Si le champ est vide au moment de la soumission, définir la date d'aujourd'hui
            $('#order-form').on('submit', function() {
                if (!dateField.val()) {
                    const today = new Date().toISOString().split('T')[0];
                    dateField.val(today);
                }
            });
        }
    });
});
</script>
{% endblock %}