{% extends 'product/base.html' %}

{% block title %}Ajuster Stock - {{ product.title }}{% endblock %}

{% block header_icon %}<i class="bi bi-arrow-up-down text-warning me-2"></i>{% endblock %}
{% block header_title %}Ajustement Rapide du Stock{% endblock %}
{% block subtitle %}Modifiez le stock de "{{ product.title }}"{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Informations Produit
                </h6>
            </div>
            <div class="card-body">
                <p class="mb-2"><strong>Nom :</strong> {{ product.title }}</p>
                <p class="mb-2"><strong>Catégorie :</strong> {{ product.category.title|default:"Sans catégorie" }}</p>
            <p class="mb-2"><strong>Prix de vente :</strong> {{ product.final_value }} {{ currency|default:'GMD' }}</p>
                <p class="mb-2">
                    <strong>Prix d'achat :</strong> 
                    {% if product.prix_achat > 0 %}
                    <span class="text-success">{{ product.prix_achat }} {{ currency|default:'GMD' }}</span>
                    {% else %}
                        <span class="text-muted">Non défini</span>
                    {% endif %}
                </p>
                <p class="mb-0">
                    <strong>Stock Actuel :</strong> 
                    <span class="badge bg-{% if product.qty > 5 %}success{% elif product.qty > 0 %}warning{% else %}danger{% endif %} fs-6">
                        {{ product.qty }} unité{{ product.qty|pluralize }}
                    </span>
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="bi bi-gear me-2"></i>
                    Actions Rapides
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-4">
                        <button class="btn btn-outline-success btn-sm w-100" onclick="setAction('add', 10)">
                            +10
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-success btn-sm w-100" onclick="setAction('add', 5)">
                            +5
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-success btn-sm w-100" onclick="setAction('add', 1)">
                            +1
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-danger btn-sm w-100" onclick="setAction('remove', 10)">
                            -10
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-danger btn-sm w-100" onclick="setAction('remove', 5)">
                            -5
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-danger btn-sm w-100" onclick="setAction('remove', 1)">
                            -1
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<form method="post" id="stock_form">
    {% csrf_token %}
    
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label for="{{ form.action.id_for_label }}" class="form-label">
                    Action à effectuer
                </label>
                {{ form.action }}
                <div class="help-text">
                    <strong>Ajouter :</strong> Augmente le stock<br>
                    <strong>Retirer :</strong> Diminue le stock<br>
                    <strong>Définir :</strong> Fixe le stock à une valeur précise
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label for="{{ form.quantity.id_for_label }}" class="form-label">
                    Quantité
                </label>
                <div class="input-group">
                    {{ form.quantity }}
                    <span class="input-group-text">unités</span>
                </div>
                {% if form.quantity.errors %}
                    <div class="text-danger mt-1">{{ form.quantity.errors.0 }}</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Section Traçabilité (visible si l'app aprovision est disponible) -->
    {% if aprovision_available %}
    <div class="card mt-4" id="tracability-section">
        <div class="card-header bg-success text-white">
            <h6 class="mb-0">
                <i class="bi bi-graph-up me-2"></i>
                Traçabilité et Coûts
                <small class="ms-2">(Optionnel pour ajustements, obligatoire pour approvisionnements)</small>
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="{{ form.prix_achat_unitaire.id_for_label }}" class="form-label">
                            Prix d'achat unitaire (FCFA) <span class="text-danger" id="prix-required">*</span>
                        </label>
                        <div class="input-group">
                            {{ form.prix_achat_unitaire }}
                            <span class="input-group-text">FCFA</span>
                        </div>
                        <small class="form-text text-muted">{{ form.prix_achat_unitaire.help_text }}</small>
                        {% if form.prix_achat_unitaire.errors %}
                            <div class="text-danger mt-1">{{ form.prix_achat_unitaire.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="{{ form.fournisseur.id_for_label }}" class="form-label">
                            Fournisseur
                        </label>
                        {{ form.fournisseur }}
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="{{ form.reference.id_for_label }}" class="form-label">
                            Référence facture
                        </label>
                        {{ form.reference }}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            Description
                        </label>
                        {{ form.description }}
                    </div>
                </div>
            </div>
            
            <!-- Calcul automatique du coût total -->
            <div class="alert alert-info" id="cost-preview" style="display: none;">
                <i class="bi bi-calculator me-2"></i>
                <strong>Coût total estimé :</strong> <span id="cost-total">0</span> FCFA
            </div>
        </div>
    </div>
    {% endif %}

    <div class="alert alert-info mt-3" id="preview" style="display: none;">
        <i class="bi bi-calculator me-2"></i>
        <strong>Aperçu :</strong> <span id="preview_text"></span>
    </div>
</form>
{% endblock %}

{% block back_text %}Retour à la Liste{% endblock %}

{% block action_buttons %}
<button type="submit" form="stock_form" class="btn btn-warning">
    <i class="bi bi-check-circle me-1"></i>
    Appliquer les Modifications
</button>
{% endblock %}

{% block extra_js %}
<script>
const currentStock = {{ product.qty }};
const aprovisionAvailable = {{ aprovision_available|yesno:"true,false" }};

function setAction(action, quantity) {
    document.getElementById('id_action').value = action;
    document.getElementById('id_quantity').value = quantity;
    updatePreview();
    updateCostPreview();
}

function updatePreview() {
    const action = document.getElementById('id_action').value;
    const quantity = parseInt(document.getElementById('id_quantity').value) || 0;
    const preview = document.getElementById('preview');
    const previewText = document.getElementById('preview_text');
    
    // Gérer l'affichage du champ prix d'achat
    if (aprovisionAvailable) {
        const prixRequired = document.getElementById('prix-required');
        const tracabilitySection = document.getElementById('tracability-section');
        
        if (action === 'add') {
            prixRequired.style.display = 'inline';
            tracabilitySection.classList.add('border-warning');
            tracabilitySection.classList.remove('border-success');
        } else {
            prixRequired.style.display = 'none';
            tracabilitySection.classList.remove('border-warning');
            tracabilitySection.classList.add('border-success');
        }
    }
    
    if (quantity > 0) {
        let newStock;
        let actionText;
        
        switch(action) {
            case 'add':
                newStock = currentStock + quantity;
                actionText = `Ajouter ${quantity} unités`;
                break;
            case 'remove':
                newStock = Math.max(0, currentStock - quantity);
                actionText = `Retirer ${quantity} unités`;
                if (currentStock < quantity) {
                    actionText += ` (limité à ${currentStock})`;
                }
                break;
            case 'set':
                newStock = quantity;
                actionText = `Définir le stock à ${quantity} unités`;
                break;
        }
        
        previewText.innerHTML = `${actionText} → <strong>Nouveau stock : ${newStock} unités</strong>`;
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
}

function updateCostPreview() {
    if (!aprovisionAvailable) return;
    
    const action = document.getElementById('id_action').value;
    const quantity = parseInt(document.getElementById('id_quantity').value) || 0;
    const prixAchat = parseFloat(document.getElementById('id_prix_achat_unitaire').value) || 0;
    const costPreview = document.getElementById('cost-preview');
    const costTotal = document.getElementById('cost-total');
    
    if (action === 'add' && quantity > 0 && prixAchat > 0) {
        const total = quantity * prixAchat;
        costTotal.textContent = total.toLocaleString();
        costPreview.style.display = 'block';
    } else {
        costPreview.style.display = 'none';
    }
}

// Validation avant soumission
function validateForm() {
    if (!aprovisionAvailable) return true;
    
    const action = document.getElementById('id_action').value;
    const prixAchat = parseFloat(document.getElementById('id_prix_achat_unitaire').value) || 0;
    
    if (action === 'add' && prixAchat <= 0) {
        alert('Le prix d\'achat unitaire est obligatoire pour les approvisionnements.');
        document.getElementById('id_prix_achat_unitaire').focus();
        return false;
    }
    
    return true;
}

// Écouter les changements
document.getElementById('id_action').addEventListener('change', function() {
    updatePreview();
    updateCostPreview();
});

document.getElementById('id_quantity').addEventListener('input', function() {
    updatePreview();
    updateCostPreview();
});

if (aprovisionAvailable) {
    document.getElementById('id_prix_achat_unitaire').addEventListener('input', updateCostPreview);
    
    // Validation du formulaire
    document.getElementById('stock_form').addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
        }
    });
}

// Initialiser les aperçus
updatePreview();
updateCostPreview();
</script>
{% endblock %}